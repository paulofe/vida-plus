<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vida+ (v4.4.2 hotfix)</title>
  <meta name="theme-color" content="#0e0f12">
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    :root{ --pad:14px; --radius:14px; --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji"; }
    *{box-sizing:border-box}
    html,body{ overflow-x:hidden }
    body{ font-family:var(--font); margin:0; background:#0e0f12; color:#f2f2f2; line-height:1.35; }
    header{ padding:10px var(--pad); position:sticky; top:0; z-index:1000;
            background:#0e0f12cc; backdrop-filter: blur(6px); border-bottom:1px solid #2a2d33;
            display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; }
    h1{margin:0;font-size:22px;}
    .centerWrap{ display:flex; align-items:center; justify-content:center; gap:10px; min-width:120px }
    .scorePill{ padding:0 2px; font-weight:800; font-variant-numeric:tabular-nums; min-width:36px; text-align:center; font-size:18px }
    .dateTop{justify-self:end; opacity:.9;font-size:14px}
    main{ display:grid; gap:16px; max-width:820px; margin:0 auto;
          padding-left:max(var(--pad), env(safe-area-inset-left));
          padding-right:max(var(--pad), env(safe-area-inset-right));
          padding-top:var(--pad); padding-bottom:120px; }
    section{ background:#15171c;border:1px solid #2a2d33;border-radius:var(--radius); padding:12px }
    section h2{margin:0 0 8px 0; font-size:16px; display:flex; align-items:center; gap:10px}
    .grid{display:grid; gap:10px}
    .g2{grid-template-columns:1fr 1fr}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .chip{ border:1px solid #3a3f47;padding:8px 10px;border-radius:12px; cursor:pointer; user-select:none; background:#15171c; color:#f2f2f2;}
    input[type=text],input[type=email]{ background:#0f1115;border:1px solid #2a2d33;border-radius:10px;color:#f2f2f2;padding:10px; width:100% }
    .btn{ background:#1f6feb;border:0;border-radius:12px;color:white;padding:12px 14px; font-weight:600; cursor:pointer; width:100%; }
    .btn.secondary{background:#242832; border:1px solid #3a3f47}
    footer.note{ font-size:12px; opacity:.6; margin-top:6px }
    .status{font-size:12px; opacity:.85}
    details summary{cursor:pointer}
  </style>
</head>
<body>
<header>
  <h1>Vida+</h1>
  <div class="centerWrap">
    <div id="scoreTop" class="scorePill">‚Äî</div>
  </div>
  <div id="dateTop" class="dateTop"></div>
</header>

<main>
  <section id="actions">
    <h2>‚öôÔ∏è A√ß√µes</h2>
    <details open>
      <summary>Configura√ß√µes</summary>
      <div class="status" id="cloudStatus">‚òÅÔ∏è Cloud: desligado</div>
      <div class="grid g2" style="margin-top:8px">
        <div>
          <label class="small muted">Supabase URL</label>
          <input type="text" id="cfgSbUrl" placeholder="https://xxxx.supabase.co">
        </div>
        <div>
          <label class="small muted">Supabase anon key</label>
          <input type="text" id="cfgSbKey" placeholder="eyJ...">
        </div>
      </div>
      <div class="grid g2" style="margin-top:8px">
        <div>
          <label class="small muted">Entrar (e-mail)</label>
          <input type="email" id="cfgEmail" placeholder="seu@email.com">
        </div>
        <div class="row">
          <button class="chip" id="btnLogin">Enviar link</button>
          <button class="chip" id="btnLogout">Sair</button>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="chip" id="btnReset">Corrigir cache</button>
      </div>
    </details>
  </section>

  <section>
    <h2>üß™ Testes r√°pidos</h2>
    <div class="row">
      <button class="chip" id="btnPing">Testar conex√£o Supabase</button>
    </div>
    <footer class="note">Se o bot√£o acima mostrar "OK", o projeto e as chaves est√£o v√°lidos.</footer>
  </section>
</main>

<script>
// ---- helpers
const DEFAULTS = { sbUrl:"", sbKey:"" };
const el = id => document.getElementById(id);
function loadSettings(){
  try{ return { ...DEFAULTS, ...(JSON.parse(localStorage.getItem("vida_plus_settings")||"{}")) }; }
  catch(e){ return {...DEFAULTS}; }
}
function saveSettings(s){
  try{ localStorage.setItem("vida_plus_settings", JSON.stringify(s)); } catch(e){}
}
function fmtDateTop(){
  const d=new Date(); const m=["jan","fev","mar","abr","mai","jun","jul","ago","set","out","nov","dez"][d.getMonth()];
  const w=["dom","seg","ter","qua","qui","sex","s√°b"][d.getDay()];
  const dd=("0"+d.getDate()).slice(-2); return dd+"/"+m+" ("+w+")";
}

// ---- UI init
el("dateTop").textContent = fmtDateTop();
el("scoreTop").textContent = "0"; // placeholder

// ---- Service Worker
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js').catch(()=>{});
}

// ---- Supabase (JS v2) lazy init
let sb = null;
let sbUser = null;
function ensureSb(){
  const s = loadSettings();
  if(!s.sbUrl || !s.sbKey) return null;
  if(sb) return sb;
  // load via global from CDN (added below)
  sb = window.supabase.createClient(s.sbUrl.trim(), s.sbKey.trim());
  return sb;
}

// ---- Buttons
el("btnReset").onclick = async () => {
  if(confirm("Limpar cache e recarregar?")){
    try {
      const regs = await navigator.serviceWorker.getRegistrations();
      for(const r of regs) await r.unregister();
    } catch(e){}
    localStorage.clear();
    location.reload();
  }
};

el("btnLogin").onclick = async () => {
  const s = loadSettings();
  s.sbUrl = el("cfgSbUrl").value.trim();
  s.sbKey = el("cfgSbKey").value.trim();
  const email = el("cfgEmail").value.trim();
  saveSettings(s);

  if(!s.sbUrl || !s.sbKey){ alert("Preencha URL e anon key do Supabase."); return; }
  if(!email){ alert("Informe seu e-mail."); return; }

  try{
    const client = ensureSb();
    if(!client){ alert("Configura√ß√£o inv√°lida."); return; }

    const { data, error } = await client.auth.signInWithOtp({
      email,
      options: {
        shouldCreateUser: true,
        emailRedirectTo: location.origin + location.pathname
      }
    });
    if(error) throw error;
    alert("Link de login enviado para "+email+". Abra no mesmo dispositivo.");
  }catch(err){
    alert("Erro ao enviar link: " + (err.message||err));
  }
};

el("btnLogout").onclick = async () => {
  const client = ensureSb();
  if(!client){ alert("Sem Supabase configurado."); return; }
  await client.auth.signOut();
  alert("Sess√£o encerrada.");
};

el("btnPing").onclick = async () => {
  const client = ensureSb();
  if(!client){ alert("Configure URL e anon key primeiro."); return; }
  try{
    // tentativa de ping simples: pedir sess√£o atual
    const { data, error } = await client.auth.getSession();
    if(error){ alert("Erro: " + error.message); return; }
    alert("OK: cliente inicializado");
  }catch(e){
    alert("Cliente inicializado.");
  }
};

// ---- hydrate settings UI
(function fill(){
  const s = loadSettings();
  el("cfgSbUrl").value = s.sbUrl || "";
  el("cfgSbKey").value = s.sbKey || "";
})();
</script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</body>
</html>
